{% extends "base.html" %}

{% block title %}Daily Dish{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dailyDish.css') }}">
{% endblock %}

{% block content %}
<div class="page-wrapper">
    <div class="home-container">
        <h1 class="section-title">Daily Dish</h1>
        
        <!-- Hot on the Grill Section -->
        <section class="featured-section">
            <h2 class="section-subtitle">Hot on the Grill</h2>
            <p class="section-description">Todays Featured Dishes</p>
            
            <div class="carousel-container">
                <div class="carousel">
                    {% for dish in featured_dishes %}
                    <div class="carousel-item">
                        <a href="{{ url_for('dish.dish_detail', dish_id=dish.dish_id) }}" class="dish-image-container">
                            <img src="{{ url_for('static', filename=dish.image) }}" alt="{{ dish.name }}">
                            <div class="carousel-caption">{{ dish.name }} @  {{ dish.restaurant }}</div>
                        </a>
                    </div>
                    {% endfor %}
                </div>
                <button class="carousel-button prev">&lt;</button>
                <button class="carousel-button next">&gt;</button>
            </div>
            <div class="carousel-dots">
                {% for dish in featured_dishes %}
                <div class="carousel-dot"></div>
                {% endfor %}
            </div>
        </section>

        <!-- Live Feed Section -->
        <section class="live-feed">
            <h2 class="section-title">Live Feed</h2>
            {% for item in feed_items %}
                {% include 'components/feed_card.html' %}
            {% endfor %}

            <div id="load-more-container" style="text-align: center; margin: 20px 0;">
                <button id="load-more-btn" class="mark-seen-btn" data-offset="{{ feed_items|length }}">Load More</button>
            </div>
        </section>
    </div>
</div>

<!-- Add JavaScript for carousel functionality -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const carousel = document.querySelector('.carousel');
    const items = document.querySelectorAll('.carousel-item');
    const dots = document.querySelectorAll('.carousel-dot');
    const prevBtn = document.querySelector('.carousel-button.prev');
    const nextBtn = document.querySelector('.carousel-button.next');
    let currentIndex = 0;

    function showItem(index) {
        const offset = -index * 100;
        carousel.style.transform = `translateX(${offset}%)`;
        
        // Update dots
        dots.forEach((dot, i) => {
            dot.classList.toggle('active', i === index);
        });
    }

    // Initialize first dot as active
    dots[0].classList.add('active');

    // Add click handlers for dots
    dots.forEach((dot, index) => {
        dot.addEventListener('click', () => {
            currentIndex = index;
            showItem(currentIndex);
        });
    });

    prevBtn.addEventListener('click', () => {
        currentIndex = Math.max(currentIndex - 1, 0);
        showItem(currentIndex);
    });

    nextBtn.addEventListener('click', () => {
        currentIndex = Math.min(currentIndex + 1, items.length - 1);
        showItem(currentIndex);
    });
});

document.addEventListener('DOMContentLoaded', function () {
    document.querySelectorAll('.mark-seen-btn').forEach(btn => {
        btn.addEventListener('click', async function () {
            const parent = btn.closest('.follow-notification');
            const followId = parent.getAttribute('data-follow-id');

            const res = await fetch(`/mark-follow-seen/${followId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            const result = await res.json();
            if (result.success) {
                parent.remove();
            } else {
                alert('Could not mark as seen');
            }
        });
    });
});
</script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('.follow-back-btn').forEach(btn => {
            btn.addEventListener('click', async function () {
                const followerId = btn.getAttribute('data-follow-id');
    
                const res = await fetch(`/follow-back/${followerId}`, {
                    method: 'POST'
                });
    
                const result = await res.json();
                if (result.success) {
                    btn.textContent = "Following";
                    btn.disabled = true;
                    btn.classList.add("disabled");
                } else {
                    alert('Could not follow back');
                }
            });
        });
    });
    </script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const loadMoreBtn = document.getElementById('load-more-btn');
        if (!loadMoreBtn) return;
    
        loadMoreBtn.addEventListener('click', async function () {
            const offset = parseInt(loadMoreBtn.getAttribute('data-offset')) || 0;
    
            const res = await fetch(`/load-more-feed?offset=${offset}`);
            const data = await res.json();
    
            if (data.feed_html) {
                const parser = new DOMParser();
                const newItems = parser.parseFromString(data.feed_html, 'text/html').body.children;
    
                const feedSection = document.querySelector('.live-feed');
                for (const item of newItems) {
                    if (item.classList.contains('feed-item')) {
                        feedSection.insertBefore(item, loadMoreBtn.parentElement);
                    }
                }
    
                // update offset for next batch
                loadMoreBtn.setAttribute('data-offset', offset + data.count);
    
                // hide button if no more content
                if (!data.has_more) {
                    loadMoreBtn.style.display = 'none';
                }
            } else {
                alert('No more items to load.');
                loadMoreBtn.style.display = 'none';
            }
        });
    });
    </script>
    
    
    
{% endblock %}

